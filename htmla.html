"""
<!DOCTYPE html>
<html>
<head>
    <title>Math Application</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: grey;
        }
        .equation-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .mathquill-editable {
            border: 1px solid #ccc;
            padding: 5px;
            min-width: 300px;
            margin-right: 20px;
        }
        .result {
            min-width: 100px;
            padding: 5px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }
        #add-equation {
            margin-top: 20px;
            padding: 10px 20px;
        }
    </style>
    <!-- MathQuill CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.css"> 
</head>
<body>
    <h1>Math Application</h1>
    <div id="equations-container">
        <!-- Existing equations will be loaded here -->
    </div>
    <button id="add-equation">Add Equation</button>

    <!-- MathQuill JS -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.js"></script>
    <script>
            const MQ = MathQuill.getInterface(2); // for backcompat

            function createEquationRow(latex='', result='') {
                const row = document.createElement('div');
                row.className = 'equation-row';

                const mathFieldSpan = document.createElement('span');
                mathFieldSpan.className = 'mathquill-editable';
                row.appendChild(mathFieldSpan);

                const resultSpan = document.createElement('span');
                resultSpan.className = 'result';
                resultSpan.innerText = result;
                row.appendChild(resultSpan);

                const mathField = MQ.MathField(mathFieldSpan, {
                    spaceBehavesLikeTab: true,
                    handlers: {
                        edit: function() {
                            computeResult(mathField.latex(), resultSpan);
                        }
                    }
                });

                if (latex) {
                    mathField.latex(latex);
                }

                return row;
            }

            function computeResult(latex, resultSpan) {
                fetch('/compute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ equation: latex })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.result !== undefined) {
                        resultSpan.innerText = data.result;
                        saveData();
                    } else {
                        resultSpan.innerText = 'Error';
                    }
                });
            }

            function loadEquations(equations) {
                const container = document.getElementById('equations-container');
                container.innerHTML = '';
                equations.forEach(eq => {
                    const row = createEquationRow(eq.equation, eq.result);
                    container.appendChild(row);
                });
            }

            function addEquation(latex='', result='') {
                const container = document.getElementById('equations-container');
                const row = createEquationRow(latex, result);
                container.appendChild(row);
            }

            function getAllEquations() {
                const rows = document.querySelectorAll('.equation-row');
                const equations = [];
                rows.forEach(row => {
                    const mathField = row.querySelector('.mathquill-editable');
                    const span = $(mathField).mathquill('latex');
                    const result = row.querySelector('.result').innerText;
                    equations.push({ equation: $(mathField).mathquill('latex'), result: result });
                });
                return equations;
            }

            function saveData() {
                const equations = getAllEquations();
                fetch('/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ equations: equations })
                });
            }

            document.getElementById('add-equation').addEventListener('click', () => {
                addEquation();
            });

            // Initial load
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    loadEquations(data.equations);
                });
        </script>
</body>
</html>
"""